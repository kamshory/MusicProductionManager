window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){let e,i=(this.document||this.ownerDocument).querySelectorAll(t),n=this;do{for(e=i.length;--e>=0&&i.item(e)!==n;);}while(e<0&&(n=n.parentElement));return n});class SrtGenerator{constructor(t,e,i){this.editorCtrl=t,this.rawData=e,this.path=i,this.audio=null,this.resolution=1,this.scale=.05,this.unit="px",this.startWidth=0,this.data=[],this.duration=0,this.durationMinimum=0,this.durationMin=100,this.editMode="",this.ended=!1,this.indexToEdit=-1,this.elementToEdit=null,this.currentDataOffsetLeft=0,this.currentDataTimeStart=0,this.startX=0,this.startWidth=0,this.editorListElement=null,this.editorMapElement=null,this.sampleRate=8e3,this.ready=!1,this.startPlayingTime=0,this.scroll=!1,this.diplayedText="",this.diplayedTextLast="",this.editor=null,this.isMouseDown=!1,this.waveformArray=[],this.lastIndex=-1,this.zoom=1,this.zoomLevelIndexOriginal=4,this.zoomLevelIndex=this.zoomLevelIndexOriginal,this.zoomLevel=[.125,.25,.5,.75,1,1.25,1.5,1.75,2],this.buttonContentPlay='<i class="srt-button-play"></i></i>',this.buttonContentPause='<i class="srt-button-pause"></i></i>',this.buttonContentStop='<i class="srt-button-stop"></i></i>',this.buttonContentTrash='<i class="srt-button-delete"></i></i>',this.closest=function(t,e){let i=t.closest(e);if(void 0!==i)return i;if("string"==typeof e){let i=t.webkitMatchesSelector?"webkitMatchesSelector":t.msMatchesSelector?"msMatchesSelector":"matches";for(;t.parentElement;){if(t[i](e))return t;t=t.parentElement}}else for(;t.parentElement;){if(t===e)return t;t=t.parentElement}return null},this.getFinalResult=function(){return this.getFinalSubtitleData()},this.getFinalSubtitleData=function(){return this.rawData},this.getElement=function(t){return this.getEditor().querySelector(t)},this.getElements=function(t){return this.getEditor().querySelectorAll(t)},this.getEditor=function(){return this.editor},this.dToDmsReal=function(t,e,i){void 0!==e&&null!=e||(e=3);let n=Math.abs(t),s=0|n,a=n-s,r=60*a|0,o=3600*a-60*r;return o=o.toFixed(e),i&&(s<10&&(s="0"+s),r<10&&(r="0"+r),o<10&&(o="0"+o)),[s,r,o]},this.ddToDms=function(t){let e=Math.abs(t),i=0|e,n=e-i,s=60*n|0,a=3600*n-60*s;return a=Math.round(1e3*a)/1e3,{d:i,m:s,s:a}},this.dmsToDd=function(t,e,i){let n=void 0!==t?parseFloat(t):0,s=void 0!==e?parseFloat(e)/60:0,a=void 0!==i?parseFloat(i)/3600:0;return n+s+a},this.dmsToDdFromString=function(t){let e=t.split(":");return this.dmsToDd(e[0],e[1],e[2])},this.ddToDmsSrtFormat=function(t){let e=this.ddToDms(t),i=e.d,n=e.m,s=e.s.toFixed(3);return i<10&&(i="0"+i),n<10&&(n="0"+n),s<10&&(s="0"+s),i+":"+n+":"+s.replace(".",",")},this.parseFloat=function(t){return null==t||"string"!=typeof t?t:t.length>0?(t=t.replace(/[^.\d]/g,""),""==t?0:Number(t)):0},this.msToUnit=function(t){return t*this.scale*this.zoom},this.unitToMs=function(t){return t/(this.scale*this.zoom)},this.sortData=function(){let t=this.data.sort(function(t,e){return n.sortCallback(t,e)});this.data=JSON.parse(JSON.stringify(t)),this.rawData=this.renderDataToText(t),this.placeRawData(this.rawData)},this.play=function(t){this.ended&&(this.startPlayingTime=0,this.audio.currentTime=0),this.audio.paused&&(this.startPlayingTime>0&&(t=this.startPlayingTime),t&&t>0&&(this.audio.currentTime=t),this.audio.play(),this.updateAudioTimePosition()),this.ended=!1,this.onPlay()},this.getDataBySecond=function(t){let e=1e3*t;for(let t in this.data)if(e>=this.data[t].start&&e<=this.data[t].end)return{index:t,data:this.data[t]};return null},this.getText=function(t){let e=this.getDataBySecond(t);return null!=e?e.data.text:""},this.stop=function(){this.pause(),this.audio.currentTime=0,this.setStartPlayingTime(0),this.onStop()},this.pause=function(t){this.audio.pause(),this.onPause(),t&&this.resetAllTimeline()},this.isPlaying=function(){return null!=this.audio&&!this.audio.paused},this.setStartPlayingTime=function(t){this.startPlayingTime=t},this.setActiveData=function(t){this.clearActiveData();let e=this.getTimelineByIndex(t);e.setAttribute("data-active","true")},this.clearActiveData=function(){let t=this.getElements(".srt-list-item");for(let e=0;e<t.length;e++)t[e].removeAttribute("data-active")},this._onTextShow=function(t,e){let i=this.getTimelineByIndex(t);this.setActiveData(t),this.lastIndex=t,i.scrollIntoView({behavior:"auto",block:"center",inline:"center"}),this.onTextShow(t,e)},this._onTextClear=function(){this.onTextClear()},this.onTextShow=function(t,e){},this.onTextClear=function(){},this.updateAudioTimePosition=function(){if(null!=this.audio){let t=-1,e=this.audio.currentTime;this.setStartPlayingTime(e);let i=this.updatePlayingTime(e);if(this.scroll){let t=this.getElement(".srt-map").parentNode.offsetWidth/2;this.getElement(".srt-map").scrollLeft=i-t;let s=this.getElement(".srt-time-position-pointer");if(s){let t=s.getAttribute("aria-describedby");t&&(document.querySelector("#"+t+" .tooltip-inner").innerText=n.ddToDmsSrtFormat(e/3600))}}let s=this.getDataBySecond(this.audio.currentTime);s?(this.diplayedText=s.data.text,t=s.index):this.diplayedText="",this.lastIndex!=t&&t>-1&&(this.setActiveData(t),n.lastIndex=t),""!=this.diplayedText&&this.diplayedTextLast!=this.diplayedText&&(this.getElement(".text-display-inner").innerHTML=this.diplayedText,this.diplayedTextLast=this.diplayedText,this._onTextShow(t,this.diplayedText)),""==this.diplayedText&&this.diplayedTextLast!=this.diplayedText&&(this.getElement(".text-display-inner").innerHTML="",this.diplayedTextLast=this.diplayedText,this._onTextClear())}this.audio.paused||window.requestAnimationFrame(()=>this.updateAudioTimePosition())},this.showTextManual=function(t,e){this.getElement(".text-display-inner").innerHTML=e,this._onTextShow(t,e)},this.clearTextManual=function(){this.getElement(".text-display-inner").innerHTML="",this._onTextClear()},this.setDuration=function(t){this.duration=t},this.createData=function(t,e){if(t){let i=this.parseTimestampMills(t),n=i.start,s=i.end,a=s-n;return{start:n,end:s,duration:a,text:e}}return{start:0,end:0,duration:0,text:e}},this.appendText=function(t,e){if(this.data.length>=t-1&&void 0!==this.data[t]){let i=this.data[t].text,n=[];null!=i&&n.push(i),e.length>0&&n.push(e),e=n.join("\r\n"),this.data[t].text=e}},this.parseRawData=function(t){t=t.trim().replace(/\r?\n/g,"\r\n");let e=t.split(/\n/g),i=-1,n=[],s=0;for(let t=0;t<e.length;t++)e[t]=e[t].trim(),this.isTimestamp(e[t])?(i++,n[i]=this.createData(e[t])):(i>-1&&(n[i].text=this.concat(n[i].text,e[t])),s++);return void 0===n[i].text&&(n[i].text=""),{data:n,nonempty:s,totalLength:e.length}},this.concat=function(t,e){let i=[];return null!=t&&i.push(t),e.length>0&&i.push(e),i.join("\r\n")},this.sortCallback=function(t,e){return t.start>e.start?1:t.start<e.start?-1:0},this.isTimestamp=function(t){return t.indexOf("-->")>-1},this.parseTimestamp=function(t){let e=t.split("-->");return{start:e[0].trim(),end:e[1].trim()}},this.parseTimestampMills=function(t){let e=this.parseTimestamp(t),i=this.convertTimestampToMills(e.start),n=this.convertTimestampToMills(e.end);return{start:i,end:n}},this.convertTimestampToMills=function(t){let e="",i="0";if(t.indexOf(",")>-1){let n=t.split(",");e=n[0],i=n[1]}else if(t.indexOf(".")>-1){let n=t.split(".");e=n[0],i=n[1]}else e=t;let n=36e5*this.dmsToDdFromString(e),s=parseFloat(i);return n+s},this.truncate=function(t){return Math.floor(t)},this.createEditorContainer=function(){this.editorListElement.innerHTML="",this.editorMapElement.innerHTML="";let t=this.createDiv("div");t.className="srt-container",t.style.width=this.msToUnit(this.durationMinimum)+this.unit,this.editorMapElement.appendChild(t)},this.appendController=function(t,e,i){let s=this.createController(t,e);this.movableElement(s,e,function(t){n.sundulKiriMove(t)},function(t){n.sundulKananMove(t)}),i?i.after(s):this.editorMapElement.querySelector(".srt-container").appendChild(s)},this.createController=function(t,e){let i=this.createDiv("div");i.classList.add("srt-controller"),i.classList.add("srt-prevent-select");let n=this.createDiv("div");n.classList.add("srt-object-inner");let s=this.createDiv("div");s.classList.add("srt-text-container"),s.innerText=t.text;let a=this.createDiv("div");return a.classList.add("srt-resizer"),n.appendChild(s),n.appendChild(a),i.appendChild(n),i.style.left=this.msToUnit(t.start)+this.unit,i.style.width=this.msToUnit(t.duration)+this.unit,i.setAttribute("data-index",e),i},this.movableElement=function(t,e,i,s){let a=t.querySelector(".srt-object-inner");a.classList.add("srt-movable");let r=a.querySelector(".srt-text-container"),o=a.querySelector(".srt-resizer");r.addEventListener("dblclick",function(t){let e=parseInt(n.closest(t.target,".srt-controller").getAttribute("data-index")),i=n.getTimelineByIndex(e);n.setActiveData(e),n.lastIndex=e,i.querySelector("textarea").focus()}),r.addEventListener("mousedown",function(t){if(n.isMouseDown=!0,n.startX=t.clientX,n.indexToEdit=t.target.parentNode.parentNode.getAttribute("data-index"),n.elementToEdit=n.getDataByIndex(n.indexToEdit),n.editMode="move",n.currentDataOffsetLeft=n.elementToEdit.offsetLeft-t.clientX,n.currentDataTimeStart=n.data[n.indexToEdit].start,!n.isPlaying()){let t=n.elementToEdit.offsetLeft,e=n.unitToMs(t)/1e3;n.ended=!1,n.updatePointerPosition(t),n.setStartPlayingTime(e)}n.resetZIndex(),n.elementToEdit.style.zIndex="10",n.showTextManual(n.indexToEdit,n.data[n.indexToEdit].text)},!0),n.getEditor().addEventListener("mousemove",function(t){if(n.isMouseDown&&("move"==n.editMode&&(n.elementToEdit.style.left=t.clientX+n.currentDataOffsetLeft+"px"),"resize"==n.editMode)){let e=n.startWidth,i=n.startX,s=t.clientX,a=e+s-i;n.elementToEdit.style.width=a+"px"}},!0),document.addEventListener("mouseup",function(t){if(n.isMouseDown){if("move"==n.editMode&&!n.isPlaying()){let t=n.elementToEdit.offsetLeft,e=n.unitToMs(t)/1e3;n.updatePointerPosition(t),n.setStartPlayingTime(e)}n.editMode="","function"==typeof i&&setTimeout(function(){i(n.indexToEdit)},100),"function"==typeof s&&setTimeout(function(){s(n.indexToEdit)},100),n.updateData()}n.isMouseDown=!1},!0),o.addEventListener("mousedown",function(t){n.indexToEdit=t.target.parentNode.parentNode.getAttribute("data-index"),n.elementToEdit=n.getDataByIndex(n.indexToEdit),n.startWidth=n.parseFloat(n.elementToEdit.style.width),n.startX=t.clientX,n.editMode="resize",n.isMouseDown=!0},!0)},this.resetZIndex=function(){let t=this.getElements(".srt-controller"),e=t.length;for(let i=0;i<e;i++)t[i].style.zIndex=""},this.getDataByIndex=function(t){return this.getControllerByIndex(t)},this.sundulKiriMove=function(t){if(t>=0&&this.data.length>0)if(0==t){if(this.data[t].start<0){let e=0;this.data[t].start=e,this.ended=!1,this.updatePlayingTime(e),this.setStartPlayingTime(e),this.updateController(t)}}else{let e=parseInt(t)-1;this.data[t].start<this.data[e].start?(this.data[e].duration>this.durationMin&&(this.data[e].duration=this.durationMin),this.data[e].end=this.data[e].start+this.data[e].duration,this.data[t].start=this.data[e].end,this.data[t].end=this.data[t].start+this.data[t].duration):this.data[t].start<this.data[e].end&&(this.data[e].end=this.data[t].start,this.data[e].duration=this.data[e].end-this.data[e].start,this.data[t].end=this.data[t].start+this.data[t].duration);let i=this.data[t].start/1e3;this.ended=!1,this.updatePlayingTime(i),this.setStartPlayingTime(i),this.updateController(e),this.updateController(t)}},this.sundulKananMove=function(t){if(this.data.length>1&&t<this.data.length-1){let e=parseInt(t)+1;if(this.data[t].start+this.data[t].duration>this.data[e].start+this.data[e].duration)this.data[t].start=n.currentDataTimeStart,this.updateController(t);else if(this.data[t].start+this.data[t].duration>this.data[e].start){this.data[t].start<this.data[e].start?(this.data[t].duration=this.data[e].start-this.data[t].start,this.data[t].start=this.data[t].start,this.data[t].duration=this.data[t].duration,this.updateController(t)):this.data[t].start<this.data[e].end&&(this.data[e].start=this.data[t].start+this.data[t].duration,this.data[e].duration=this.data[e].end-this.data[e].start,this.updateController(e));let i=this.data[t].start/1e3;this.ended=!1,this.updatePlayingTime(i),this.setStartPlayingTime(i)}}},this.updateData=function(){let t=[],e=this.getElements(".srt-controller");for(let i in e){let n=e[i];if(void 0!==n.className&&n.classList.contains("srt-controller")){let e=n.querySelector(".srt-object-inner .srt-text-container").innerText.trim(),i=this.getTimestampFromController(n.offsetLeft,n.style.width),s=i.start,a=i.end,r=i.duration;t.push({start:s,end:a,duration:r,text:e})}}this.data=t,this.updateRawData()},this.updateRawData=function(){let t=this.renderDataToText(this.data);this.placeRawData(t),this.updateTimelineData(),this.rawData=t},this.updateTimelineData=function(){for(let t in this.data)this.updateTimelineDataAt(t)},this.updateTimelineDataAt=function(t){let e=this.data[t],i=this.getTimelineByIndex(t),n=this.dToDmsReal(e.start/36e5).join(":"),s=this.dToDmsReal(e.end/36e5).join(":");i.querySelector(".srt-time-edit-start").value=n,i.querySelector(".srt-time-edit-end").value=s},this.renderDataToText=function(t){t=t||this.data;let e=[];for(let i in t){let n=t[i],s=this.createTimestamp(n.start,n.end);e.push(s),e.push(n.text),e.push("")}return e.join("\r\n")},this.createTimestamp=function(t,e){let i=this.ddToDmsSrtFormat(t/36e5),n=this.ddToDmsSrtFormat(e/36e5),s=i+" --> "+n;return s},this.getTimestampFromController=function(t,e){let i=t/(this.scale*this.zoom),n=this.parseFloat(e)/(this.scale*this.zoom),s=i+n;return{start:i,end:s,duration:n}},this.renderData=function(){this.data.forEach((t,e)=>{this.appendController(t,e),this.appendList(t,e)})},this.createDiv=function(){return document.createElement("div")},this.createControllerContainer=function(t,e){let i=this.dToDmsReal(t.start/36e5).join(":"),s=this.dToDmsReal(t.end/36e5).join(":"),a=this.createDiv();return a.classList.add("srt-list-item"),a.classList.add("row"),a.innerHTML='\n                <div class="col col-6 col-lg-9 srt-text-editor"><textarea class="srt-text-edit" spellcheck="false"></textarea></div>\n                <div class="col col-2 col-lg-1 srt-remover">\n                <button class="srt-button button-play" data-play="false"><i class="srt-button-play"></i></button>\n                <button class="srt-button button-trash"><i class="srt-button-delete"></i></button>\n                </div>\n                <div class="col col-3 col-lg-2 text-center srt-time">\n                <div class="srt-time-edit-container"><input type="text" class="srt-time-edit srt-time-edit-start"></div>\n                <div class="srt-time-edit-container"><input type="text" class="srt-time-edit srt-time-edit-end"></div>\n                </div>\n                ',a.querySelector(".srt-text-edit").value=t.text,a.querySelector(".srt-time-edit-start").value=i,a.querySelector(".srt-time-edit-end").value=s,a.setAttribute("data-index",e),a.querySelector(".button-trash").addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),n._onDeleteData(t)}),a.querySelector(".button-play").addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),n._onTogglePlayPause(t)}),a.querySelector(".srt-text-edit").addEventListener("blur",function(t){n.updateData(),n.closest(t.target,".srt-list-item").removeAttribute("data-active")}),a.querySelector(".srt-text-edit").addEventListener("change",function(t){n._onUpdateText(t)}),a.querySelector(".srt-text-edit").addEventListener("keyup",function(t){n._onUpdateText(t)}),a.querySelector(".srt-text-edit").addEventListener("keydown",function(t){if(!("Enter"!==t.key&&13!==t.keyCode||t.shiftKey||t.altKey||t.ctrlKey)){t.preventDefault(),t.stopPropagation();let e=t.target,i=n.getCursorPos(e),s="",a="",r=e.value,o=!1;i<r.length?(s=r.substring(0,i).trim(),a=r.substring(i).trim(),o=!0):s=r;let l,d,h=n.closest(e,".srt-list-item"),u=parseInt(h.getAttribute("data-index")),c=h.parentElement.childElementCount-1,m=h.querySelector(".srt-time-edit-start").value,f=h.querySelector(".srt-time-edit-end").value,p=n.convertTimestampToMills(m),T=n.convertTimestampToMills(f),g=T-p,x=g,y=!1;u==c&&T+g<1e3*n.duration?(l=T,d=l+g):(g/=2,x/=2,T=p+g,l=T,d=l+x,y=!0);let v={start:p,end:T,duration:g,text:s},D={start:l,end:d,duration:x,text:a};n.splitData(h,u,v,D,y,o)}}),a},this.splitData=function(t,e,i,n,s,a){let r,o=parseInt(e)+1,l=t.parentElement.childElementCount-1,d=this.createControllerContainer(n,o),h=this.getControllerByIndex(e);for(let i=l;i>e;i--)r=i+1,t.parentElement.querySelector('[data-index="'+i+'"]').setAttribute("data-index",r),h.parentElement.querySelector('[data-index="'+i+'"]').setAttribute("data-index",r);if(t.after(d),s){let e=i.end,n=i.duration,s=i.text,a=this.dToDmsReal(e/36e5).join(":");t.querySelector(".srt-time-edit-end").value=a,t.querySelector(".srt-text-edit").value=s,h.querySelector(".srt-text-container").innerText=s,h.style.width=this.msToUnit(n)+this.unit}if(a){let e=i.text;t.querySelector(".srt-text-edit").value=e,h.querySelector(".srt-text-container").innerText=e}d.querySelector("textarea").focus(),this.appendController(n,o,h);let u=[];for(let t=0;t<e;t++)u.push(JSON.parse(JSON.stringify(this.data[t])));u.push(i),u.push(n);for(let t=e+1;t<this.data.length;t++)u.push(JSON.parse(JSON.stringify(this.data[t])));this.data=JSON.parse(JSON.stringify(u)),this.updateRawData()},this._onEnded=function(t){this.resetAllTimeline(),this.ended=!0,this.onEnded()},this.onPlay=function(){},this.onPause=function(){},this.onStop=function(){},this.onEnded=function(){},this.onDeleteData=function(t,e){e>1&&this.deleteData(t)},this.onDrawWaveformStart=function(){},this.onDrawWaveformFinish=function(){},this.onDrawWaveformError=function(){},this.onUpdateText=function(t,e){},this.resetAllTimeline=function(){let t=this.getElements(".srt-list-item .button-play"),e=t.length;for(let i=0;i<e;i++)t[i].setAttribute("data-play","false"),t[i].innerHTML=this.buttonContentPlay},this._onTogglePlayPause=function(t){let e=t.target;e.classList.contains("button-play")||(e=n.closest(e,".button-play"));let i=e.getAttribute("data-play")||"false";if("false"==i){this.resetAllTimeline(),e.innerHTML=this.buttonContentPause,e.setAttribute("data-play","true");let t=n.closest(e,".srt-list-item"),i=t.querySelector(".srt-time-edit-start").value,s=this.convertTimestampToMills(i)/1e3;this.ended=!1,this.setStartPlayingTime(s),this.audio.currentTime=s,this.play(s)}else e.setAttribute("data-play","false"),e.innerHTML=this.buttonContentPlay,this.pause()},this._onDeleteData=function(t){let e=t.target,i=n.closest(e,".srt-list-item"),s=parseInt(i.getAttribute("data-index")),a=i.parentNode.childNodes.length;this.onDeleteData(s,a)},this.deleteData=function(t){let e=this.getTimelineByIndex(t),i=this.getControllerByIndex(t);if(i){i.parentNode.removeChild(i),e.parentNode.removeChild(e);let s,a=n.getElement(".srt-list-container").childNodes,r=a.length;for(s=0;s<r;s++)a[s].setAttribute("data-index",s);let o=n.getElement(".srt-container").childNodes,l=a.length;for(s=0;s<l;s++)o[s].setAttribute("data-index",s);let d=[];for(s=0;s<t;s++)d.push(JSON.parse(JSON.stringify(this.data[s])));for(s=t+1;s<this.data.length;s++)d.push(JSON.parse(JSON.stringify(this.data[s])));this.data=JSON.parse(JSON.stringify(d)),this.updateRawData()}},this._onUpdateText=function(t){let e=t.target,i=n.closest(e,".srt-list-item"),s=parseInt(i.getAttribute("data-index")),a=e.value;this.updateTextController(s,a),void 0!==this.data[s]&&(this.data[s].text=a),this.onUpdateText(s,a)},this.updateTextController=function(t,e){n.getElement('.srt-controller[data-index="'+t+'"] .srt-text-container').innerText=e},this.getDuration=function(t,e){let i=this.convertTimestampToMills(t),n=this.convertTimestampToMills(e);return n-i},this.getCursorPos=function(t){let e=0;if("selectionStart"in t)e=t.selectionStart;else if("selection"in document){t.focus();let i=document.selection.createRange(),n=document.selection.createRange().text.length;i.moveStart("character",-t.value.length),e=i.text.length-n}return e},this.appendList=function(t,e){let i=this.createControllerContainer(t,e);this.editorListElement.appendChild(i)},this.placeRawData=function(t){this.getElement(".srt-text-raw").value=t},this.renderConstroller=function(){this.placeRawData(this.rawData),this.createEditorContainer(),this.renderData()},this.getChunkSize=function(){return Math.round(this.sampleRate/(1e3*this.resolution*this.scale))},this.getControllerByIndex=function(t){return this.getElement('.srt-controller[data-index="'+t+'"]')},this.getTimelineByIndex=function(t){return this.getElement('.srt-list-item[data-index="'+t+'"]')},this.drawAudioWaveform=function(t,e){e=e||1,this.resolution=e,n.onDrawWaveformStart();let i=this.getChunkSize()*e,s=new AudioContext({sampleRate:this.sampleRate}),a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer",a.onload=(()=>{s.decodeAudioData(a.response).then(t=>{let e=t.getChannelData(0),s=[],a=0,r=0,o=e.length;for(;a<o;)r=a,a+=i,s.push(e.slice(r,a).reduce(function(t,e){return Math.max(t,Math.abs(e))}));n.waveformArray=s,n.renderWaveform()}).catch(t=>{n.onDrawWaveformError()})}),a.send()},this.drawTimeline=function(){let t=this.zoom>.25?.5:1,e=this.zoom>.25?5:10,i=this.getElement(".srt-timeline-canvas"),n=Math.round(this.msToUnit(1e3*this.duration)),s=i.getContext("2d");i.setAttribute("width",n),i.setAttribute("height",40),this.getElement(".srt-timestamp").style.width=n+this.unit,this.getElement(".srt-edit-area").style.width=n+this.unit,s.textAlign="center",s.font="12px Arial",s.fillStyle="#555555",s.strokeStyle="#555555",s.beginPath(),s.lineWidth=1;let a=-1,r=10,o=14,l=26;for(let i=0;i<this.duration;i+=t){let n=Math.round(this.msToUnit(1e3*i));if(s.moveTo(n,0),i>a+t){let t=this.dToDmsReal(i/3600,0,!0).join(":");try{s.fillText(t,n,l)}catch(t){}a+=e,s.lineTo(n,o)}else s.lineTo(n,r)}s.stroke()},this.renderWaveform=function(){let t=n.waveformArray,e=this.getElement(".srt-timeline-canvas-edit"),i=0,s=e.height,a=Math.ceil(s/2),r=(s-2*i)/2;e.width=t.length*this.zoom;let o=e.getContext("2d");o.beginPath(),o.strokeWith=Math.ceil(this.zoom),o.strokeStyle="rgb(88, 175, 215)";for(let e=0;e<t.length;e++){let n=Math.round(i+Number(e)*this.zoom);o.moveTo(n,a-t[e]*r),o.lineTo(n,a+t[e]*r)}o.stroke(),n.onDrawWaveformFinish()},this.updateZoom=function(t){this.zoom=t,this.updateControllerScale()},this.updateControllerScale=function(){this.renderWaveform();for(let t in this.data)this.updateController(t);n.drawTimeline(),this.updatePlayingTime(this.startPlayingTime)},this.updateController=function(t){let e=this.getControllerByIndex(t);e.style.left=this.msToUnit(this.data[t].start)+this.unit,e.style.width=this.msToUnit(this.data[t].duration)+this.unit},this.setAudioTimePosition=function(t){let e=this.unitToMs(t)/1e3;this.audio.currentTime=e,this.setStartPlayingTime(e)},this.updatePointerPosition=function(t){t-=3,this.getElement(".srt-time-position-pointer").style.left=t+this.unit},this.updatePlayingTime=function(t){let e=this.msToUnit(1e3*t);return this.updatePointerPosition(e),e},this.getAbsoluteOffsetLeft=function(t){let e=0,i=t;for(;null!==i;)e+=i.offsetLeft,e-=i.scrollLeft,i=i.offsetParent;return e},this.getAbsoluteOffsetTop=function(t){let e=0,i=t;for(;null!==i;)e+=i.offsetTop,e-=i.scrollTop,i=i.offsetParent;return e},this.onMouseWheel=function(t){1==t.ctrlKey&&(t.preventDefault(),t.deltaY>0?(this.zoomLevelIndex--,this.zoomLevelIndex<0&&(this.zoomLevelIndex=0)):(this.zoomLevelIndex++,this.zoomLevelIndex>this.zoomLevel.length-1&&(this.zoomLevelIndex=this.zoomLevel.length-1)),this.getElement(".srt-zoom-control").value=this.zoomLevelIndex);let e=this.zoomLevel[this.zoomLevelIndex];this.updateZoom(e)},this.distributedParsing=function(t){let e=[];t=t.trim().replace(/\r?\n/g,"\r\n");let i=t.split(/\n/g),n=i.length,s=1e3*this.duration/n,a=.95*s,r=0,o="";for(let t=0;t<i.length;t++)if(r=s*t,o=i[t].trim(),o.length>0){let t={start:r,duration:a,end:r+s,text:o};e.push(t)}return e},this.renderAll=function(){this.data.length>0&&(this.sortData(),this.durationMinimum=this.data[this.data.length-1].end/1e3,this.duration<this.durationMinimum&&(this.duration=this.durationMinimum)),this.renderConstroller(),this.drawAudioWaveform(i,1)},this.toggleScroll=function(){n.scroll=!n.scroll},this.initEditor=function(){this.audio=new Audio(this.path),this.duration=this.audio.duration,this.editor=document.querySelector(this.editorCtrl),this.getElement(".srt-zoom-control").value=this.zoomLevelIndexOriginal,this.getElement(".srt-zoom-control").addEventListener("change",function(t){n.zoomLevelIndex=t.target.value,n.zoomLevelIndex<0&&(n.zoomLevelIndex=0),n.zoomLevelIndex>n.zoomLevel.length-1&&(n.zoomLevelIndex=n.zoomLevel.length-1);let e=n.zoomLevel[n.zoomLevelIndex];n.updateZoom(e)}),this.audio.addEventListener("loadedmetadata",function(t){n.duration=n.audio.duration,n.ready=!0,n.drawTimeline()}),this.audio.onended=function(t){n._onEnded(t)},this.audio.load(),this.editorListElement=this.getElement(".srt-list-container"),this.editorMapElement=this.getElement(".srt-map-srt-container"),this.getElement(".srt-timeline-canvas").addEventListener("click",function(t){let e=n.getAbsoluteOffsetLeft(t.target),i=t.clientX+n.getElement(".srt-map").scrollLeft-e,s=n.unitToMs(i)/1e3;n.updatePointerPosition(i);let a=n.getDataBySecond(s);null!=a?n.showTextManual(a.index,a.data.text):n.clearTextManual(),n.ended=!1,n.setStartPlayingTime(s),n.audio.currentTime=s}),this.getElement(".srt-map").addEventListener("wheel",function(t){n.onMouseWheel(t)}),this.getElement(".srt-text-raw").addEventListener("paste",function(t){t.preventDefault(),t.stopPropagation();let e=t.clipboardData.getData("text"),i=n.parseRawData(e);if(0==i.data.length&&i.nonempty>1&&n.data.length<2){let t=n.distributedParsing(e);n.data=t,n.renderAll()}}),document.body.addEventListener("keydown",function(t){if(t.ctrlKey&&48==window.event.keyCode){n.zoomLevelIndex=n.zoomLevelIndexOriginal,n.getElement(".srt-zoom-control").value=n.zoomLevelIndex;let t=n.zoomLevel[n.zoomLevelIndex];n.updateZoom(t)}});let t=n.getElement('[data-toggle="tooltip"]');new bootstrap.Tooltip(t,{boundary:document.body});t.addEventListener("mouseover",function(t){let e=t.target,i=e.offsetLeft+3,s=n.unitToMs(i)/36e5,a=n.ddToDmsSrtFormat(s);e.setAttribute("data-bs-original-title",a)}),this.data=this.parseRawData(this.rawData).data,this.renderAll()};let n=this;n.initEditor()}}